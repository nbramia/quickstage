#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

async function releaseWorkflow() {
  try {
    console.log('üöÄ QuickStage Extension Release Workflow');
    console.log('=====================================\n');

    // Step 1: Bump version
    console.log('1Ô∏è‚É£ Bumping version...\n');
    execSync('npm run version:bump', { stdio: 'inherit' });
    console.log('‚úÖ Version bumped successfully\n');

    // Step 2: Build extension
    console.log('2Ô∏è‚É£ Building extension...\n');
    execSync('npm run build', { stdio: 'inherit' });
    console.log('‚úÖ Extension built successfully\n');

    // Step 3: Package extension
    console.log('3Ô∏è‚É£ Packaging extension...\n');
    execSync('npm run package', { stdio: 'inherit' });
    console.log('‚úÖ Extension packaged successfully\n');

    // Step 4: Copy VSIX to web app public directory for direct serving
    console.log('4Ô∏è‚É£ Copying VSIX to web app for direct serving...\n');
    const webPublicDir = path.join(__dirname, '../web/public');
    
    // Find the VSIX file that was just created
    const vsixFiles = fs.readdirSync(__dirname).filter(f => f.endsWith('.vsix'));
    if (vsixFiles.length === 0) {
      throw new Error('No VSIX file found after packaging');
    }
    const vsixSource = path.join(__dirname, vsixFiles[0]);
    
    // Create public directory if it doesn't exist
    if (!fs.existsSync(webPublicDir)) {
      fs.mkdirSync(webPublicDir, { recursive: true });
    }
    
    // Copy VSIX to web app public directory
    fs.copyFileSync(vsixSource, path.join(webPublicDir, 'quickstage.vsix'));
    console.log('‚úÖ VSIX copied to web app public directory\n');

    // Step 5: Update web app version info
    console.log('5Ô∏è‚É£ Updating web app version info...\n');
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const version = packageJson.version;
    
    // Update web app's version info file
    const webVersionFile = path.join(__dirname, '../web/src/version.ts');
    const versionContent = `// Auto-generated by release workflow
export const EXTENSION_VERSION = '${version}';
export const EXTENSION_DOWNLOAD_URL = '/quickstage.vsix';
export const EXTENSION_CHECK_URL = '/api/extensions/version';
`;
    
    fs.writeFileSync(webVersionFile, versionContent);
    console.log('‚úÖ Web app version info updated\n');

    console.log('üéâ Release workflow completed successfully!');
    console.log(`üì¶ Extension v${version} is ready for deployment\n`);
    
    console.log('üìã Next steps:');
    console.log('1. Build the web app: cd apps/web && pnpm build');
    console.log('2. Deploy the web app: cd ../../infra && npx wrangler pages deploy dist --project-name=quickstage');
    console.log('3. Test the new extension download from the dashboard');
    console.log(`4. The new version ${version} will be automatically detected by users`);

  } catch (error) {
    console.error('‚ùå Release workflow failed:', error);
    process.exit(1);
  }
}

releaseWorkflow();
